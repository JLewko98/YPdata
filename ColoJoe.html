<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ColoJoe's Matches</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    nav {
      background-color: #1f1f1f;
      padding: 10px 20px;
      display: flex;
      gap: 20px;
      border-bottom: 1px solid #333;
    }

    nav a {
      color: #f5f5f5;
      text-decoration: none;
      font-weight: bold;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    .summary {
      font-size: 1.2em;
      margin-bottom: 15px;
    }

    button {
      margin-bottom: 15px;
      padding: 8px 12px;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #333;
      text-align: left;
    }

    th {
      background-color: #2a2a2a;
      cursor: pointer;
    }

    .win {
      background-color: #225522;
    }

    .loss {
      background-color: #552222;
    }

    .hero-img {
      height: 32px;
      margin-right: 8px;
    }

    .hero-cell {
      display: flex;
      align-items: center;
    }

    a {
      color: #66b2ff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a>
    <a href="ColoJoe.html">ColoJoe</a>
    <a href="#">DotaNinjas</a>
    <a href="#">Sanidin</a>
    <a href="#">Sweep</a>
    <a href="#">Kanth Donos</a>
  </nav>

  <main>
    <h1>ColoJoe's Matches</h1>
    <div id="winSummary" class="summary">Loading match data...</div>
    <!-- <button onclick="fetchMatchData()">Refresh Data</button> -->
    <button onclick="downloadCSV()">Export to CSV</button>

    <table id="matchTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)">Match</th>
          <th onclick="sortTable(1)">Hero</th>
          <th onclick="sortTable(2)">Duration</th>
          <th onclick="sortTable(3)">K / D / A</th>
          <th onclick="sortTable(4)">Result</th>
          <th onclick="sortTable(5)">Date</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <script>
    const API_KEY = "8d34e6e0-182c-4946-a206-08a59c6f1088";
    const ACCOUNT_ID = 86745912; // Updated ColoJoe Account ID
    const MATCHES_URL = `https://api.opendota.com/api/players/${ACCOUNT_ID}/matches?limit=10000&api_key=${API_KEY}`;
    const HEROES_URL = `https://api.opendota.com/api/heroes`;
    const HERO_IMG_BASE = "https://cdn.cloudflare.steamstatic.com/apps/dota2/images/dota_react/heroes/";

    const tableBody = document.querySelector("#matchTable tbody");
    const winSummary = document.getElementById("winSummary");
    let matchDataRows = [];

    async function fetchMatchData() {
      try {
        const [matchesResponse, heroesResponse] = await Promise.all([
          fetch(MATCHES_URL),
          fetch(HEROES_URL)
        ]);

        const matches = await matchesResponse.json();
        const heroes = await heroesResponse.json();

        const heroMap = {};
        heroes.forEach(hero => {
          heroMap[hero.id] = {
            name: hero.name.replace("npc_dota_hero_", ""),
            localized_name: hero.localized_name
          };
        });

        const filteredMatches = matches.slice(0, 50).reverse();

        let winCount = 0;
        matchDataRows = [];
        tableBody.innerHTML = "";

        filteredMatches.forEach(match => {
          const isRadiant = match.player_slot < 128;
          const didWin = (isRadiant && match.radiant_win) || (!isRadiant && !match.radiant_win);
          if (didWin) winCount++;

          const hero = heroMap[match.hero_id] || { name: "unknown", localized_name: "Unknown Hero" };
          const heroImg = `${HERO_IMG_BASE}${hero.name}.png`;

          const duration = `${Math.floor(match.duration / 60)}m ${match.duration % 60}s`;
          const date = new Date(match.start_time * 1000);
          const formattedDate = date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });

          const kda = `${match.kills} / ${match.deaths} / ${match.assists}`;
          const result = didWin ? "Win" : "Loss";
          const matchLink = `https://www.opendota.com/matches/${match.match_id}`;

          matchDataRows.push([
            match.match_id,
            hero.localized_name,
            duration,
            kda,
            result,
            formattedDate
          ]);

          const row = document.createElement("tr");
          row.className = didWin ? "win" : "loss";

          row.innerHTML = `
            <td><a href="${matchLink}" target="_blank">${match.match_id}</a></td>
            <td class="hero-cell"><img src="${heroImg}" class="hero-img" alt="${hero.localized_name}">${hero.localized_name}</td>
            <td data-seconds="${match.duration}">${duration}</td>
            <td data-kills="${match.kills}">${kda}</td>
            <td>${result}</td>
            <td data-timestamp="${match.start_time}">${formattedDate}</td>
          `;

          tableBody.appendChild(row);
        });

        const winPct = ((winCount / filteredMatches.length) * 100).toFixed(1);
        winSummary.textContent = `Win Rate: ${winCount} / ${filteredMatches.length} matches (${winPct}%)`;

      } catch (err) {
        console.error("Failed to fetch match data:", err);
        winSummary.textContent = "Failed to load match data.";
        tableBody.innerHTML = `<tr><td colspan="6">Error loading data.</td></tr>`;
      }
    }

    let sortDirection = true;
    function sortTable(colIndex) {
      const rows = Array.from(tableBody.rows);
      rows.sort((a, b) => {
        const aCell = a.cells[colIndex];
        const bCell = b.cells[colIndex];

        switch (colIndex) {
          case 0: return sortDirection ? aCell.innerText - bCell.innerText : bCell.innerText - aCell.innerText;
          case 1: return sortDirection ? aCell.innerText.localeCompare(bCell.innerText) : bCell.innerText.localeCompare(aCell.innerText);
          case 2: return sortDirection ? aCell.dataset.seconds - bCell.dataset.seconds : bCell.dataset.seconds - aCell.dataset.seconds;
          case 3: return sortDirection ? aCell.dataset.kills - bCell.dataset.kills : bCell.dataset.kills - aCell.dataset.kills;
          case 4: return sortDirection ? aCell.innerText.localeCompare(bCell.innerText) : bCell.innerText.localeCompare(aCell.innerText);
          case 5: return sortDirection ? aCell.dataset.timestamp - bCell.dataset.timestamp : bCell.dataset.timestamp - aCell.dataset.timestamp;
        }
      });

      sortDirection = !sortDirection;
      tableBody.innerHTML = "";
      rows.forEach(row => tableBody.appendChild(row));
    }

    function downloadCSV() {
      const headers = ["Match ID", "Hero", "Duration", "K/D/A", "Result", "Date"];
      const csvContent = [
        headers.join(","),
        ...matchDataRows.map(row => row.map(value => `"${value}"`).join(","))
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "colojoe_matches.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    fetchMatchData();
  </script>
</body>
</html>
