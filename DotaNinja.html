<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DotaNinJas Last 50 Matches</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    h1, h2 {
      margin-bottom: 10px;
    }

    .summary {
      font-size: 1.2em;
      margin-bottom: 15px;
    }

    button {
      margin-bottom: 15px;
      padding: 8px 12px;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background-color: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background-color: #f4f4f4;
      cursor: pointer;
    }

    .win {
      background-color: #d4edda;
    }

    .loss {
      background-color: #f8d7da;
    }

    .hero-img {
      height: 32px;
      vertical-align: middle;
      margin-right: 8px;
    }

    .hero-cell {
      display: flex;
      align-items: center;
    }

    a {
      color: #0077cc;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>DotaNinJas Last 50 Dota 2 Matches</h1>
  <div id="winSummary" class="summary">Loading win percentage...</div>
  <button onclick="downloadCSV()">Export to CSV</button>

  <table id="matchTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Match</th>
        <th onclick="sortTable(1)">Hero</th>
        <th onclick="sortTable(2)">Duration</th>
        <th onclick="sortTable(3)">K / D / A</th>
        <th onclick="sortTable(4)">Result</th>
        <th onclick="sortTable(5)">Date</th>
      </tr>
    </thead>
    <tbody>
      <!-- Match data goes here -->
    </tbody>
  </table>

  <script>
    const API_KEY = "8d34e6e0-182c-4946-a206-08a59c6f1088";
    const ACCOUNT_ID = 366924678; // DotaNinJas Steam32 ID
    const MATCHES_URL = `https://api.opendota.com/api/players/${ACCOUNT_ID}/matches?limit=50&api_key=${API_KEY}`;
    const HEROES_URL = `https://api.opendota.com/api/heroes`;
    const HERO_IMG_BASE = "https://cdn.cloudflare.steamstatic.com/apps/dota2/images/dota_react/heroes/";

    const table = document.getElementById("matchTable");
    const tableBody = table.querySelector("tbody");
    const winSummary = document.getElementById("winSummary");

    let matchDataRows = [];

    async function fetchMatchData() {
      try {
        const [matchesResponse, heroesResponse] = await Promise.all([
          fetch(MATCHES_URL),
          fetch(HEROES_URL)
        ]);

        let matches = await matchesResponse.json();
        const heroes = await heroesResponse.json();

        matches = matches.reverse();

        const heroMap = {};
        heroes.forEach(hero => {
          heroMap[hero.id] = {
            name: hero.name.replace("npc_dota_hero_", ""),
            localized_name: hero.localized_name
          };
        });

        let winCount = 0;
        matchDataRows = [];
        tableBody.innerHTML = "";

        matches.forEach(match => {
          const isRadiant = match.player_slot < 128;
          const didWin = (isRadiant && match.radiant_win) || (!isRadiant && !match.radiant_win);
          if (didWin) winCount++;

          const heroData = heroMap[match.hero_id] || { name: "unknown", localized_name: "Unknown Hero" };
          const heroImageUrl = `${HERO_IMG_BASE}${heroData.name}.png`;

          const durationMinutes = Math.floor(match.duration / 60);
          const durationSeconds = match.duration % 60;
          const formattedDuration = `${durationMinutes}m ${durationSeconds}s`;

          const matchDate = new Date(match.start_time * 1000);
          const formattedDate = matchDate.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });

          const kda = `${match.kills} / ${match.deaths} / ${match.assists}`;
          const result = didWin ? "Win" : "Loss";
          const matchLink = `https://www.opendota.com/matches/${match.match_id}`;

          matchDataRows.push([
            match.match_id,
            heroData.localized_name,
            formattedDuration,
            kda,
            result,
            formattedDate
          ]);

          const row = document.createElement("tr");
          row.className = didWin ? "win" : "loss";

          row.innerHTML = `
            <td>${match.match_id}</td>
            <td class="hero-cell"><img src="${heroImageUrl}" class="hero-img" alt="${heroData.localized_name}">${heroData.localized_name}</td>
            <td data-seconds="${match.duration}">${formattedDuration}</td>
            <td data-kills="${match.kills}">${kda}</td>
            <td>${result}</td>
            <td data-timestamp="${match.start_time}">${formattedDate}</td>
          `;

          // Replace match ID cell with link
          row.cells[0].innerHTML = `<a href="${matchLink}" target="_blank">${match.match_id}</a>`;

          tableBody.appendChild(row);
        });

        const winPercentage = ((winCount / matches.length) * 100).toFixed(1);
        winSummary.textContent = `Win Rate: ${winCount} / ${matches.length} matches (${winPercentage}%)`;
      } catch (error) {
        console.error("Error fetching data:", error);
        winSummary.textContent = "Error loading win percentage.";
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="6">Error loading match data.</td>`;
        tableBody.appendChild(row);
      }
    }

    // Sorting
    let sortDirection = true;
    function sortTable(colIndex) {
      const rows = Array.from(tableBody.rows);

      rows.sort((a, b) => {
        const aCell = a.cells[colIndex];
        const bCell = b.cells[colIndex];

        switch (colIndex) {
          case 0: // Match ID
            return sortDirection
              ? aCell.innerText - bCell.innerText
              : bCell.innerText - aCell.innerText;
          case 1: // Hero
            return sortDirection
              ? aCell.innerText.localeCompare(bCell.innerText)
              : bCell.innerText.localeCompare(aCell.innerText);
          case 2: // Duration
            return sortDirection
              ? aCell.dataset.seconds - bCell.dataset.seconds
              : bCell.dataset.seconds - aCell.dataset.seconds;
          case 3: // Kills (from K/D/A)
            return sortDirection
              ? aCell.dataset.kills - bCell.dataset.kills
              : bCell.dataset.kills - aCell.dataset.kills;
          case 4: // Result
            return sortDirection
              ? aCell.innerText.localeCompare(bCell.innerText)
              : bCell.innerText.localeCompare(aCell.innerText);
          case 5: // Date
            return sortDirection
              ? aCell.dataset.timestamp - bCell.dataset.timestamp
              : bCell.dataset.timestamp - aCell.dataset.timestamp;
          default:
            return 0;
        }
      });

      sortDirection = !sortDirection;

      tableBody.innerHTML = "";
      rows.forEach(row => tableBody.appendChild(row));
    }

    // CSV Export
    function downloadCSV() {
      const headers = ["Match ID", "Hero", "Duration", "K/D/A", "Result", "Date"];
      const csvContent = [
        headers.join(","),
        ...matchDataRows.map(row => row.map(value => `"${value}"`).join(","))
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "dotaninjas_matches.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    fetchMatchData();
  </script>
</body>
</html>
